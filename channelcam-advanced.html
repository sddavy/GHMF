<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Channel Cam Viewer - Custom Controls</title>
<link rel="icon" href="assets/logo.png" type="image/png" />
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@panzoom/panzoom@9.4.0/dist/panzoom.min.js"></script>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; background-color: #000; color: white; font-family: sans-serif;
    display: flex; flex-direction: column; align-items: center;
  }
  body {
    min-height: 100vh;
  }
  .video-container {
    position: relative;
    width: 100%;
    max-width: 1200px;
    background: #000;
    user-select: none;
  }
  video {
    width: 100%;
    height: 675px; /* 16:9 ratio for 1200px wide */
    display: block;
    background: #000;
    object-fit: contain;
    border-radius: 6px;
  }
  #timestamp {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0,0,0,0.5);
    padding: 5px 10px;
    font-size: 1rem;
    display: none;
    border-radius: 4px;
    pointer-events: none;
    user-select: none;
    z-index: 10;
  }
  .controls-container {
    max-width: 1200px;
    margin: 15px 0 40px;
    background: #111;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    padding: 10px 15px;
    user-select: none;
  }
  .controls-container button {
    background: #222;
    border: none;
    border-radius: 5px;
    color: white;
    padding: 10px 16px;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .controls-container button:hover {
    background: #444;
  }
  .custom-controls {
    flex: 1 1 400px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .custom-controls button {
    background: transparent;
    border: none;
    color: white;
    font-size: 22px;
  }
  .custom-controls button:hover {
    color: #87CEFA;
  }
  .progress-container {
    flex-grow: 1;
    height: 10px;
    background: #444;
    border-radius: 5px;
    cursor: pointer;
    position: relative;
  }
  .progress-filled {
    height: 100%;
    background: #87CEFA;
    width: 0%;
    border-radius: 5px;
    transition: width 0.1s linear;
  }
  /* Screen flash animation */
  #flash {
    pointer-events: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: white;
    opacity: 0;
    z-index: 9999;
    transition: opacity 0.25s ease-out;
  }
  #flash.active {
    opacity: 0.8;
    transition: opacity 0.25s ease-in;
  }
</style>
</head>
<body>

<div class="video-container" id="videoContainer">
  <video id="video" muted autoplay playsinline></video>
  <div id="timestamp"></div>
</div>

<div class="controls-container" id="controlsContainer">

  <!-- Playback Controls -->
  <div class="custom-controls" id="playbackControls">
    <button id="playPauseBtn" title="Play/Pause">‚ñ∫</button>
    <button id="muteBtn" title="Mute/Unmute">üîà</button>
    <div class="progress-container" id="progressContainer" title="Seek">
      <div class="progress-filled" id="progressFilled"></div>
    </div>
    <button id="pipBtn" title="Picture in Picture">üóî</button>
    <button id="fullscreenBtn" title="Fullscreen">‚õ∂</button>
  </div>

  <!-- Other Controls -->
  <button id="zoomInBtn" title="Zoom In">Ôºã Zoom In</button>
  <button id="zoomOutBtn" title="Zoom Out">‚àí Zoom Out</button>
  <button id="screenshotBtn" title="Take Screenshot">üì∏ Screenshot</button>
  <button id="recordBtn" title="Start Recording">‚è∫Ô∏è Start Recording</button>
  <button id="timestampBtn" title="Toggle Timestamp">‚è∞ Toggle Timestamp</button>
</div>

<!-- Screen flash element -->
<div id="flash"></div>

<script>
  const video = document.getElementById('video');
  const timestamp = document.getElementById('timestamp');
  const container = document.getElementById('videoContainer');

  const streamUrl = 'https://s78.ipcamlive.com/streams/4eyaqdwio6nlevp1t/stream.m3u8';

  // Setup HLS.js or native HLS
  if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(streamUrl);
    hls.attachMedia(video);
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = streamUrl;
  } else {
    container.innerHTML = '<p style="color: white; text-align: center;">Your browser does not support HLS playback. Please use a supported browser.</p>';
  }

  // Playback Controls Elements
  const playPauseBtn = document.getElementById('playPauseBtn');
  const muteBtn = document.getElementById('muteBtn');
  const progressContainer = document.getElementById('progressContainer');
  const progressFilled = document.getElementById('progressFilled');
  const pipBtn = document.getElementById('pipBtn');
  const fullscreenBtn = document.getElementById('fullscreenBtn');

  // Other Controls Elements
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const screenshotBtn = document.getElementById('screenshotBtn');
  const recordBtn = document.getElementById('recordBtn');
  const timestampBtn = document.getElementById('timestampBtn');

  // Play/pause toggle
  function togglePlayPause() {
    if (video.paused) {
      video.play();
    } else {
      video.pause();
    }
  }
  playPauseBtn.addEventListener('click', togglePlayPause);
  video.addEventListener('play', () => playPauseBtn.textContent = '‚ùö‚ùö');
  video.addEventListener('pause', () => playPauseBtn.textContent = '‚ñ∫');

  // Mute/unmute toggle
  function toggleMute() {
    video.muted = !video.muted;
    muteBtn.textContent = video.muted ? 'üîá' : 'üîà';
  }
  muteBtn.addEventListener('click', toggleMute);

  // Progress Bar Update
  video.addEventListener('timeupdate', () => {
    if (video.duration) {
      const percent = (video.currentTime / video.duration) * 100;
      progressFilled.style.width = percent + '%';
    }
  });

  // Seeking through progress bar
  progressContainer.addEventListener('click', e => {
    const rect = progressContainer.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const newTime = (clickX / rect.width) * video.duration;
    video.currentTime = newTime;
  });

  // Picture in Picture toggle
  pipBtn.addEventListener('click', async () => {
    try {
      if (document.pictureInPictureElement) {
        await document.exitPictureInPicture();
      } else {
        if (video.readyState === 4) {
          await video.requestPictureInPicture();
        }
      }
    } catch (err) {
      alert('Picture-in-Picture not supported or failed.');
    }
  });

  // Fullscreen toggle
  fullscreenBtn.addEventListener('click', () => {
    if (!document.fullscreenElement) {
      container.requestFullscreen();
    } else {
      document.exitFullscreen();
    }
  });

  // Panzoom setup for zoom buttons and mouse wheel zoom anywhere on container
  let panZoom;
  window.addEventListener('load', () => {
    panZoom = Panzoom(video, { maxScale: 5, minScale: 1, contain: 'outside' });
    container.addEventListener('wheel', e => {
      e.preventDefault();
      panZoom.zoomWithWheel(e);
    }, { passive: false });
  });

  zoomInBtn.addEventListener('click', () => panZoom.zoomIn());
  zoomOutBtn.addEventListener('click', () => panZoom.zoomOut());

  // Screenshot function with flash and concise filename
  const flash = document.getElementById('flash');
  function doFlash() {
    flash.classList.add('active');
    setTimeout(() => flash.classList.remove('active'), 200);
  }
  function formatDate(date) {
    // Format YYYYMMDD_HHMMSS
    const pad = n => n.toString().padStart(2,'0');
    return date.getFullYear() +
           pad(date.getMonth() +1) +
           pad(date.getDate()) + '_' +
           pad(date.getHours()) +
           pad(date.getMinutes()) +
           pad(date.getSeconds());
  }
  function takeScreenshot() {
    if (video.videoWidth === 0 || video.videoHeight === 0) {
      alert('Video not ready for screenshot.');
      return;
    }
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    canvas.toBlob(blob => {
      if (blob) {
        const filename = `screenshot-${formatDate(new Date())}.png`;
        saveAs(blob, filename);
        doFlash();
      }
    });
  }
  screenshotBtn.addEventListener('click', takeScreenshot);

  // Recording setup
  let recorder;
  let recording = false;
  let chunks = [];
  function toggleRecording() {
    if (!recording) {
      const stream = video.captureStream();
      recorder = new MediaRecorder(stream);
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'video/webm' });
        saveAs(blob, `recording-${formatDate(new Date())}.webm`);
        chunks = [];
      };
      recorder.start();
      recording = true;
      recordBtn.textContent = '‚èπÔ∏è Stop Recording';
    } else {
      recorder.stop();
      recording = false;
      recordBtn.textContent = '‚è∫Ô∏è Start Recording';
    }
  }
  recordBtn.addEventListener('click', toggleRecording);

  // Timestamp toggle and update
  let showTimestamp = false;
  function toggleTimestamp() {
    showTimestamp = !showTimestamp;
    timestamp.style.display = showTimestamp ? 'block' : 'none';
  }
  timestampBtn.addEventListener('click', toggleTimestamp);

  setInterval(() => {
    if (showTimestamp) {
      const now = new Date();
      timestamp.textContent = now.toLocaleTimeString();
    }
  }, 1000);
</script>

</body>
</html>
